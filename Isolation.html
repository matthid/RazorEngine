<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>RazorEngine Isolation API
</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Simple templating using Razor syntax.">
    <meta name="author" content="Matthew Abbott">

    <script src="https://code.jquery.com/jquery-1.8.0.js"></script>
    <script src="https://code.jquery.com/ui/1.8.23/jquery-ui.js"></script>
    <script src="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link href="https://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css" rel="stylesheet">

    <link type="text/css" rel="stylesheet" href="https://matthid.github.io/RazorEngine/content/style.css" />
    <link type="text/css" rel="stylesheet" href="https://matthid.github.io/RazorEngine/content/prism.css" />
    <script type="text/javascript" src="https://matthid.github.io/RazorEngine/content/tips.js"></script>
	<script type="text/javascript" src="https://matthid.github.io/RazorEngine/content/prism.js"></script>
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a href="http://fsharp.org">fsharp.org</a></li>
          <li><a href="http://tpetricek.github.io/FSharp.Formatting/"><img height="16" width="16" src="http://fsharp.org/images/thumbs/FSharp.Formatting.png" /> F# Formatting</a></li>
        </ul>
        <h3 class="muted"><a href="https://matthid.github.io/RazorEngine/index.html">RazorEngine</a></h3>
      </div>
      <hr />
      <div class="row">
        <div class="span9" id="main">
          
<h1><a name="RazorEngine-Isolation-API" class="anchor" href="#RazorEngine-Isolation-API">RazorEngine Isolation API</a></h1>

<p>RazorEngine provides an additional layer of security by allowing you to run the generated code within an secured sandbox.
All you need to do is use <code>IsolatedRazorEngineService.Create</code> instead of <code>RazorEngineService.Create</code>. 
This will immediately switch the compilation and execution to another AppDomain.
However this new AppDomain still has no permission restrictions so what you want to do is provide either your own IAppDomainFactory 
or use the Func<AppDomain> overloads of <code>IsolatedRazorEngineService.Create</code>:</p>

<pre class="line-numbers language-csharp"><code class="language-csharp">public static AppDomain SandboxCreator()
{
    Evidence ev = new Evidence();
    ev.AddHostEvidence(new Zone(SecurityZone.Internet));
    PermissionSet permSet = SecurityManager.GetStandardSandbox(ev);
    // We have to load ourself with full trust
    StrongName razorEngineAssembly = typeof(RazorEngineService).Assembly.Evidence.GetHostEvidence&lt;StrongName&gt;();
    // We have to load Razor with full trust (so all methods are SecurityCritical)
    // This is because we apply AllowPartiallyTrustedCallers to RazorEngine, because
    // We need the untrusted (transparent) code to be able to inherit TemplateBase.
    // Because in the normal environment/appdomain we run as full trust and the Razor assembly has no security attributes
    // it will be completely SecurityCritical. 
    // This means we have to mark a lot of our members SecurityCritical (which is fine).
    // However in the sandbox domain we have partial trust and because razor has no Security attributes that means the
    // code will be transparent (this is where we get a lot of exceptions, because we now have different security attributes)
    // To work around this we give Razor full trust in the sandbox as well.
    StrongName razorAssembly = typeof(RazorTemplateEngine).Assembly.Evidence.GetHostEvidence&lt;StrongName&gt;();
    AppDomainSetup adSetup = new AppDomainSetup();
    adSetup.ApplicationBase = AppDomain.CurrentDomain.SetupInformation.ApplicationBase;
    AppDomain newDomain = AppDomain.CreateDomain(&quot;Sandbox&quot;, null, adSetup, permSet, razorEngineAssembly, razorAssembly);
    return newDomain;
}</code></pre>

<p>You can use the above method like this to create an AppDomain with partial trust (internet security zone):</p>

<pre class="line-numbers language-csharp"><code class="language-csharp">public void IsolatedRazorEngineService_BadTemplate_InSandbox()
{
    using (var service = IsolatedRazorEngineService.Create(SandboxCreator))
    {
        string file = Path.Combine(Environment.CurrentDirectory, Path.GetRandomFileName());

        string template = @&quot;</code></pre>

<p>@using System.IO
@{
File.WriteAllText(""<span class="math">\(file\)</span>"", ""BAD DATA"");
}".Replace("<span class="math">\(file\)</span>", file.Replace("\", "\\"));
            Assert.Throws<SecurityException>(() =>
            {
                service.RunCompile(template, "test");
            });</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
        <span class="i">Assert</span><span class="o">.</span><span class="i">IsFalse</span>(<span class="i">File</span><span class="o">.</span><span class="i">Exists</span>(<span class="i">file</span>));
    }
}</pre>
</td>
</tr>
</table>

<p>As you can see this template will throw a SecurityException as there is no way for it
to write into a file of the local harddrive.</p>


        </div>
        <div class="span3">
          <a href="https://matthid.github.io/RazorEngine/index.html">
            <img src="https://matthid.github.io/RazorEngine/images/logo.png" style="width:140px;height:140px;margin:10px 0px 0px 35px;border-style:none;" />
          </a>

          <ul class="nav nav-list" id="menu">

            <li class="nav-header">RazorEngine</li>

            <li class="divider"></li>
            <li><a href="https://www.nuget.org/packages/RazorEngine.N/">Get RazorEngine package via NuGet</a></li>
            <li><a href="https://github.com/matthid/RazorEngine">Source Code</a></li>
            <li><a href="https://github.com/matthid/RazorEngine/issues">Open bugs and feature requests</a></li>
            <li><a href="https://github.com/matthid/RazorEngine/issues/new">Report Issue or Request Feature</a></li>
            <li><a href="https://github.com/matthid/RazorEngine/blob/master/doc/LICENSE.md">License (MS-PL)</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/Contributing.html">Contributing</a></li>
            
            <li class="nav-header">Documentation</li>
              
            <li><a href="https://matthid.github.io/RazorEngine/index.html">Quick Intro</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/AboutRazor.html">About Razor and its Syntax</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/TemplateBasics.html">Templating basics</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/Encoding.html">Encoding Values in Razor</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/Isolation.html">Isolation and Sandboxing</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/Caching.html">Caching API</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/DevelopReadme.html">Development Intro</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/ReleaseNotes.html">Release Notes</a></li>
            <li><a href="https://matthid.github.io/RazorEngine/IntellisenseAndResharper.html">Intellisense and ReSharper</a></li>

            <li class="nav-header">Reference</li>
              
            <li><a href="https://matthid.github.io/RazorEngine/references/index.html">API Reference</a></li>

          </ul>
        </div>
      </div>
    </div>
      <a href="https://github.com/matthid/RazorEngine"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>
    </body>
  </html>
